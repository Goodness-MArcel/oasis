<section class="admin-section" data-aos="fade-up">
  <% const hasEnrolledCourses =
    typeof enrolledCourses !== "undefined" &&
    Array.isArray(enrolledCourses) &&
    enrolledCourses.length > 0;
  const hasAvailableCourses =
    typeof availableCourses !== "undefined" &&
    Array.isArray(availableCourses) &&
    availableCourses.length > 0;
  %>

  <div class="row g-4 align-items-center mb-3">
    <div class="col-12 col-md-8">
      <h1 class="h4 mb-1">My Courses</h1>
      <p class="text-muted small mb-0">Search, resume and discover new courses.</p>
    </div>
    <div class="col-12 col-md-4 mt-3 mt-md-0">
      <form class="d-flex" id="courseSearchForm" autocomplete="off">
        <input
          type="search"
          id="courseSearchInput"
          class="form-control form-control-sm"
          placeholder="Search courses by title..."
        >
        <button type="submit" class="btn btn-primary btn-sm ms-2">Search</button>
      </form>
    </div>
  </div>

  <div class="row g-4">
    <!-- Enrolled courses -->
    <div class="col-12">
      <div class="admin-card h-100">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h2 class="h6 mb-0">Enrolled Courses</h2>
          <a href="/user/dashboard" class="small text-decoration-none">Back to dashboard</a>
        </div>

        <div id="enrolledCoursesList" class="mt-2">
          <% if (hasEnrolledCourses) { %>
            <% enrolledCourses.forEach(function(course) { %>
              <article
                class="border rounded-3 p-3 mb-3 course-card course-search-item shadow-sm bg-white"
                data-title="<%= course.title || '' %>"
              >
                <div class="d-flex align-items-start gap-3">
                  <div class="flex-shrink-0">
                    <img
                      src="<%= course.image
                        ? (course.image.startsWith('/')
                            ? course.image
                            : '/' + course.image)
                        : '/images/python.png' %>"
                      alt="<%= course.title || 'Course image' %>"
                      class="rounded-3 border"
                      style="width: 104px; height: 104px; object-fit: cover;"
                    >
                  </div>
                  <div class="flex-grow-1">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                      <div>
                        <h3 class="h6 mb-1"><%= course.title || 'Untitled course' %></h3>
                        <% if (course.level) { %>
                          <span class="badge bg-success-subtle text-success small">
                            <%= course.level %>
                          </span>
                        <% } %>
                      </div>
                      <% if (course.progress != null) { %>
                        <span class="badge bg-success-subtle text-success small ms-2">
                          <%= course.progress %>%
                        </span>
                      <% } %>
                    </div>
                    <p class="small text-muted mb-2">
                      <%= course.description || 'No description available yet.' %>
                    </p>
                    <p class="small text-muted mb-2">
                      <i class="fa-solid fa-book-open me-1"></i>
                      Lessons: <%= typeof course.lessons !== 'undefined' && course.lessons != null ? course.lessons : 0 %>
                      &nbsp;·&nbsp;
                      <i class="fa-solid fa-users me-1"></i>
                      Enrolled: <%= typeof course.enrolledCount !== 'undefined' && course.enrolledCount != null ? course.enrolledCount : 0 %>
                    </p>
                    <% if (typeof course.price !== 'undefined' && course.price !== null) { %>
                      <p class="small mb-2 text-success fw-semibold">
                        <i class="fa-solid fa-tag me-1"></i>
                        ₦<%= course.price %>
                      </p>
                    <% } %>
                    <% if (course.progress != null) { %>
                      <div class="progress mb-2" style="height: 6px; background-color: #e9f5ee;">
                        <div
                          class="progress-bar bg-success"
                          role="progressbar"
                          style="width: <%= Math.max(0, Math.min(100, course.progress)) %>%"
                          aria-valuenow="<%= course.progress %>"
                          aria-valuemin="0"
                          aria-valuemax="100"
                        ></div>
                      </div>
                    <% } %>
                    <div class="d-flex justify-content-between align-items-center small mt-1">
                      <span class="text-muted">
                        <i class="fa-solid fa-layer-group me-1"></i>
                        <%= course.level || 'All levels' %>
                      </span>
                      <a
                        href="<%= course.link || '#' %>"
                        class="btn btn-outline-primary btn-sm"
                      >
                        Continue
                      </a>
                    </div>
                  </div>
                </div>
              </article>
            <% }); %>
          <% } else { %>
            <div class="text-center py-4 text-muted small">
              <p class="mb-1">You haven't enrolled in any course yet.</p>
              <p class="mb-0">Browse the available courses on the right to get started.</p>
            </div>
          <% } %>
        </div>
      </div>
    </div>

    <!-- Available courses -->
    <div class="col-12">
      <div class="admin-card h-100">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h2 class="h6 mb-0">Available Courses</h2>
          <span class="badge bg-light text-muted small">
            <% if (hasAvailableCourses) { %>
              <%= availableCourses.length %> courses
            <% } else { %>
              0 courses
            <% } %>
          </span>
        </div>

        <div id="availableCoursesList" class="mt-2">
          <% if (hasAvailableCourses) { %>
            <div class="row g-3">
              <% availableCourses.forEach(function(course) { %>
                <div class="col-12 col-md-6 col-xl-4 course-search-item" data-aos="fade-up" data-title="<%= course.title || '' %>">
                  <div
                    class="course-card h-100 d-flex flex-column border rounded-3 bg-white shadow-sm"
                  >
                    <div class="course-card-body p-3 pb-2">
                      <div class="mb-3">
                        <img
                          src="<%= course.image
                            ? (course.image.startsWith('/')
                                ? course.image
                                : '/' + course.image)
                            : '/images/python.png' %>"
                          alt="<%= course.title || 'Course image' %>"
                          class="rounded-3 border w-100"
                          style="max-height: 190px; object-fit: cover;"
                        >
                      </div>
                      <% if (course.level || course.category) { %>
                        <span class="badge rounded-pill bg-outline-primary small mb-2">
                          <%= course.level || 'All levels' %>
                        </span>
                      <% } %>
                      <h3 class="h6 fw-bold mb-2"><%= course.title || 'Untitled course' %></h3>
                      <p class="small text-muted mb-2">
                        <%= course.description || 'No description available yet.' %>
                      </p>
                      <p class="small mb-1">
                        <strong>Lessons:</strong>
                        <%= typeof course.lessons !== 'undefined' && course.lessons != null ? course.lessons : 0 %>
                        &nbsp;·&nbsp;
                        <strong>Enrolled:</strong>
                        <%= typeof course.enrolledCount !== 'undefined' && course.enrolledCount != null ? course.enrolledCount : 0 %>
                      </p>
                      <% if (typeof course.price !== 'undefined' && course.price !== null) { %>
                        <p class="small mb-1 text-success fw-semibold">
                          <i class="fa-solid fa-tag me-1"></i>
                          ₦<%= course.price %>
                        </p>
                      <% } %>
                    </div>
                    <div class="course-card-footer px-3 pb-3 mt-auto">
                      <div class="d-flex justify-content-between align-items-center mb-2 small text-muted">
                        <span><strong>Duration:</strong> <%= course.duration || 'Self-paced' %></span>
                        <span><strong>Level:</strong> <%= course.level || 'All levels' %></span>
                      </div>
                      <a
                        href="#"
                        class="btn btn-outline-success w-100 btn-sm btn-course-details"
                        role="button"
                        data-bs-toggle="modal"
                        data-bs-target="#userCourseDetailsModal"
                        data-id="<%= course.id %>"
                        data-title="<%= course.title || 'Untitled course' %>"
                        data-description="<%= course.description || 'No description available yet.' %>"
                        data-image="<%= course.image
                          ? (course.image.startsWith('/')
                              ? course.image
                              : '/' + course.image)
                          : '/images/python.png' %>"
                        data-level="<%= course.level || 'All levels' %>"
                        data-duration="<%= course.duration || 'Self-paced' %>"
                        data-lessons="<%= typeof course.lessons !== 'undefined' && course.lessons != null ? course.lessons : 0 %>"
                        data-enrolled="<%= typeof course.enrolledCount !== 'undefined' && course.enrolledCount != null ? course.enrolledCount : 0 %>"
                        data-price="<%= typeof course.price !== 'undefined' && course.price !== null ? course.price : '' %>"
                      >
                        Details
                      </a>
                    </div>
                  </div>
                </div>
              <% }); %>
            </div>
          <% } else { %>
            <div class="text-center py-4 text-muted small">
              <p class="mb-1">No courses are available yet.</p>
              <p class="mb-0">Please check back soon for new content.</p>
            </div>
          <% } %>
        </div>
      </div>
    </div>
  </div>

  <script>
    (function () {
      const searchForm = document.getElementById("courseSearchForm");
      const searchInput = document.getElementById("courseSearchInput");
      const courseItems = document.querySelectorAll(".course-search-item");

      if (!searchForm || !searchInput || !courseItems.length) return;

      const applyFilter = () => {
        const query = searchInput.value.trim().toLowerCase();

        courseItems.forEach((item) => {
          const title = (item.getAttribute("data-title") || "").toLowerCase();
          const matches = !query || title.includes(query);
          item.style.display = matches ? "" : "none";
        });
      };

      searchForm.addEventListener("submit", (event) => {
        event.preventDefault();
        applyFilter();
      });

      searchInput.addEventListener("input", applyFilter);

      // Details modal handlers
      const detailsButtons = document.querySelectorAll(".btn-course-details");

      if (detailsButtons.length) {
        detailsButtons.forEach((btn) => {
          btn.addEventListener("click", (e) => {
            const d = e.currentTarget.dataset;

            // Resolve modal elements at click time so they exist
            const imgEl = document.getElementById("detailsCourseImage");
            const titleEl = document.getElementById("detailsCourseTitle");
            const levelEl = document.getElementById("detailsCourseLevel");
            const durationEl = document.getElementById("detailsCourseDuration");
            const priceEl = document.getElementById("detailsCoursePrice");
            const metaEl = document.getElementById("detailsCourseMeta");
            const descEl = document.getElementById("detailsCourseDescription");
            const idInput = document.getElementById("detailsCourseIdInput");

            if (imgEl) imgEl.src = d.image || "/images/python.png";
            if (titleEl) titleEl.textContent = d.title || "Course title";
            if (levelEl) levelEl.textContent = d.level || "All levels";
            if (durationEl) durationEl.textContent = d.duration || "Self-paced";

            if (priceEl) {
              if (d.price) {
                priceEl.textContent = `₦${d.price}`;
                priceEl.style.display = "";
              } else {
                priceEl.textContent = "";
                priceEl.style.display = "none";
              }
            }

            if (metaEl) {
              const lessons = d.lessons || "0";
              const enrolled = d.enrolled || "0";
              metaEl.textContent = `Lessons: ${lessons} • Enrolled: ${enrolled}`;
            }

            if (descEl) descEl.textContent = d.description || "No description available yet.";

            if (idInput) idInput.value = d.id || "";
          });
        });
      }
    })();
  </script>
</section>
