<section class="admin-page-header mb-4" data-aos="fade-up">
    <div class="d-flex align-items-center justify-content-between">
        <div>
            <h1 class="h4 mb-1">Analytics &amp; Insights</h1>
            <p class="text-muted small mb-0">Track users, courses and engagement across your platform.</p>
        </div>
        <div class="d-flex gap-2">
            <button type="button" class="btn btn-outline-secondary btn-sm">
                <i class="fa-solid fa-file-export me-1"></i> Export report
            </button>
            <button type="button" class="btn btn-success btn-sm">
                <i class="fa-solid fa-arrow-rotate-right me-1"></i> Refresh
            </button>
        </div>
    </div>
</section>

<!-- High-level KPIs -->
<section class="row g-3 mb-4" data-aos="fade-up" data-aos-delay="50">
    <div class="col-sm-6 col-lg-3">
        <div class="admin-card p-3 h-100">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <span class="small text-muted">Total Users</span>
                <span class="text-success"><i class="fa-solid fa-users"></i></span>
            </div>
            <div class="h3 mb-1"><%= typeof totalUsers !== 'undefined' ? totalUsers : 0 %></div>
            <div class="small text-muted">All registered users on the platform</div>
        </div>
    </div>
    <div class="col-sm-6 col-lg-3">
        <div class="admin-card p-3 h-100">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <span class="small text-muted">Active Courses</span>
                <span class="text-success"><i class="fa-solid fa-graduation-cap"></i></span>
            </div>
            <div class="h3 mb-1"><%= typeof activeCourses !== 'undefined' ? activeCourses : 0 %></div>
            <div class="small text-muted">Online and in-house training currently available</div>
        </div>
    </div>
    <div class="col-sm-6 col-lg-3">
        <div class="admin-card p-3 h-100">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <span class="small text-muted">Enrollments (all time)</span>
                <span class="text-success"><i class="fa-solid fa-user-check"></i></span>
            </div>
            <div class="h3 mb-1"><%= typeof totalEnrollments !== 'undefined' ? totalEnrollments : 0 %></div>
            <div class="small text-muted">Across all courses and programs</div>
        </div>
    </div>
    <div class="col-sm-6 col-lg-3">
        <div class="admin-card p-3 h-100">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <span class="small text-muted">Avg. completion rate</span>
                <span class="text-success"><i class="fa-solid fa-chart-line"></i></span>
            </div>
            <div class="h3 mb-1"><%= typeof avgCompletionRate !== 'undefined' ? avgCompletionRate : 0 %>&percnt;</div>
            <div class="small text-muted">Based on completed vs total enrollments</div>
        </div>
    </div>
</section>

<!-- Traffic and engagement -->
<section class="row g-3 mb-4" data-aos="fade-up" data-aos-delay="100">
    <div class="col-lg-8">
        <div class="admin-card p-3 h-100">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div>
                    <h2 class="h6 mb-1">Traffic &amp; Engagement</h2>
                    <p class="small text-muted mb-0">Daily signups and course views over time.</p>
                </div>
                <select id="trafficRangeSelect" class="form-select form-select-sm" style="max-width: 140px;">
                    <option value="7" <%= (typeof rangeDays !== 'undefined' ? rangeDays : 7) === 7 ? 'selected' : '' %>>Last 7 days</option>
                    <option value="30" <%= (typeof rangeDays !== 'undefined' && rangeDays === 30) ? 'selected' : '' %>>Last 30 days</option>
                    <option value="90" <%= (typeof rangeDays !== 'undefined' && rangeDays === 90) ? 'selected' : '' %>>Last 90 days</option>
                </select>
            </div>
            <div class="analytics-chart-placeholder rounded-3 border border-dashed p-3">
                <canvas id="trafficEngagementChart" height="120"></canvas>
            </div>
        </div>
    </div>
    <div class="col-lg-4">
        <div class="admin-card p-3 h-100">
            <h2 class="h6 mb-3">Key Channels</h2>
            <ul class="list-unstyled small mb-0">
                <li class="d-flex justify-content-between align-items-center mb-2">
                    <span><i class="fa-brands fa-google me-2 text-muted"></i>Organic search</span>
                    <span class="fw-semibold">52%</span>
                </li>
                <li class="d-flex justify-content-between align-items-center mb-2">
                    <span><i class="fa-brands fa-facebook me-2 text-muted"></i>Social media</span>
                    <span class="fw-semibold">23%</span>
                </li>
                <li class="d-flex justify-content-between align-items-center mb-2">
                    <span><i class="fa-solid fa-envelope-open-text me-2 text-muted"></i>Email campaigns</span>
                    <span class="fw-semibold">15%</span>
                </li>
                <li class="d-flex justify-content-between align-items-center">
                    <span><i class="fa-solid fa-link me-2 text-muted"></i>Referrals &amp; partners</span>
                    <span class="fw-semibold">10%</span>
                </li>
            </ul>
        </div>
    </div>
</section>

<!-- Course performance and recent activity -->
<section class="row g-3" data-aos="fade-up" data-aos-delay="150">
    <div class="col-lg-7">
        <div class="admin-card p-3 h-100">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h2 class="h6 mb-0">Top Performing Courses</h2>
                <span class="small text-muted">By enrollments and completion</span>
            </div>
            <div class="table-responsive">
                <table class="table table-sm align-middle mb-0">
                    <thead class="small text-muted">
                        <tr>
                            <th>Course</th>
                            <th>Enrollments</th>
                            <th>Completion</th>
                            <th class="text-end">Status</th>
                        </tr>
                    </thead>
                    <tbody class="small">
                        <% const topList = Array.isArray(topCourses) ? topCourses : []; %>
                        <% if (topList.length) { %>
                            <% topList.forEach(function(course) { %>
                                <tr>
                                    <td>
                                        <div class="fw-semibold"><%= course.title || 'Untitled course' %></div>
                                        <div class="text-muted"><%= course.category || 'Course' %></div>
                                    </td>
                                    <td><%= course.totalEnrollments %></td>
                                    <td><%= course.completionRate %>&percnt;</td>
                                    <td class="text-end">
                                        <span class="badge <%= course.statusLabel === 'Growing' ? 'bg-success-soft' : (course.statusLabel === 'Stable' ? 'bg-primary-soft' : 'bg-warning-soft') %>"><%= course.statusLabel %></span>
                                    </td>
                                </tr>
                            <% }); %>
                        <% } else { %>
                            <tr>
                                <td colspan="4" class="text-center py-3 text-muted">
                                    <i class="fa-solid fa-circle-info me-1"></i>
                                    No course performance data available yet.
                                </td>
                            </tr>
                        <% } %>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <div class="col-lg-5">
        <div class="admin-card p-3 h-100">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h2 class="h6 mb-0">Recent Activity</h2>
                <span class="small text-muted">Last 24 hours</span>
            </div>
            <ul class="list-unstyled small mb-0">
                <% const activityList = Array.isArray(recentEnrollments) ? recentEnrollments : []; %>
                <% if (activityList.length) { %>
                    <% activityList.forEach(function(enrollment) { %>
                        <% const user = enrollment.user || {}; %>
                        <% const course = enrollment.course || {}; %>
                        <% let badgeClass = 'bg-warning-soft'; %>
                        <% let iconClass = 'fa-bell'; %>
                        <% let titleText = 'Activity'; %>
                        <% if (enrollment.status === 'enrolled') { badgeClass = 'bg-success-soft'; iconClass = 'fa-user-plus'; titleText = 'New enrollment'; } %>
                        <% if (enrollment.status === 'completed') { badgeClass = 'bg-primary-soft'; iconClass = 'fa-check-circle'; titleText = 'Course completed'; } %>
                        <% const created = enrollment.createdAt ? enrollment.createdAt.toISOString().slice(0, 16).replace('T', ' ') : ''; %>
                        <li class="mb-2 d-flex align-items-start">
                            <span class="badge <%= badgeClass %> me-2 mt-1">
                                <i class="fa-solid <%= iconClass %>"></i>
                            </span>
                            <div>
                                <div>
                                    <strong><%= titleText %>:</strong>
                                    <%= user.username || user.email || 'A user' %>
                                    <% if (course.title) { %>
                                        <% if (enrollment.status === 'completed') { %>
                                            completed "<%= course.title %>"
                                        <% } else { %>
                                            enrolled in "<%= course.title %>"
                                        <% } %>
                                    <% } %>
                                </div>
                                <% if (created) { %>
                                    <div class="text-muted"><%= created %></div>
                                <% } %>
                            </div>
                        </li>
                    <% }); %>
                <% } else { %>
                    <li class="text-muted d-flex align-items-center">
                        <i class="fa-solid fa-circle-info me-2"></i>
                        No recent enrollment activity recorded yet.
                    </li>
                <% } %>
            </ul>
        </div>
    </div>
</section>

<script>
    (function () {
        const ctxEl = document.getElementById('trafficEngagementChart');
        if (!ctxEl || typeof Chart === 'undefined') return;

        const labels = <%- JSON.stringify(typeof trafficLabels !== "undefined" ? trafficLabels : []) %>;
        const signups = <%- JSON.stringify(typeof trafficSignups !== "undefined" ? trafficSignups : []) %>;
        const enrollments = <%- JSON.stringify(typeof trafficEnrollments !== "undefined" ? trafficEnrollments : []) %>;

        const ctx = ctxEl.getContext('2d');

        new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'New signups',
                        data: signups,
                        borderColor: 'rgba(25, 135, 84, 1)',
                        backgroundColor: 'rgba(25, 135, 84, 0.12)',
                        tension: 0.3,
                        fill: true,
                        pointRadius: 3,
                        pointBackgroundColor: 'rgba(25, 135, 84, 1)',
                    },
                    {
                        label: 'New enrollments',
                        data: enrollments,
                        borderColor: 'rgba(13, 110, 253, 1)',
                        backgroundColor: 'rgba(13, 110, 253, 0.10)',
                        tension: 0.3,
                        fill: true,
                        pointRadius: 3,
                        pointBackgroundColor: 'rgba(13, 110, 253, 1)',
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                plugins: {
                    legend: {
                        display: true,
                        labels: { boxWidth: 12, usePointStyle: true }
                    },
                    tooltip: {
                        callbacks: {
                            label: function (ctx) {
                                const label = ctx.dataset.label || '';
                                const value = ctx.parsed.y || 0;
                                return label + ': ' + value;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        ticks: {
                            autoSkip: true,
                            maxTicksLimit: 7,
                        }
                    },
                    y: {
                        beginAtZero: true,
                        ticks: {
                            precision: 0,
                        }
                    }
                }
            }
        });

        // Sync range filter with chart data via page reload
        const rangeSelect = document.getElementById('trafficRangeSelect');
        if (rangeSelect) {
            rangeSelect.addEventListener('change', function () {
                const value = this.value;
                try {
                    const url = new URL(window.location.href);
                    url.searchParams.set('range', value);
                    window.location.href = url.toString();
                } catch (e) {
                    // Fallback for older browsers
                    const qs = window.location.search;
                    const base = window.location.pathname;
                    const params = new URLSearchParams(qs);
                    params.set('range', value);
                    window.location.href = base + '?' + params.toString();
                }
            });
        }
    })();
</script>